# JUMAN++ マニュアル
-----

森田 一 (hmorita@i.kyoto-u.ac.jp)  
河原 大輔 (dk@i.kyoto-u.ac.jp)  
黒橋 禎夫 (kuro@i.kyoto-u.ac.jp)  

## 1. 概要
**JUMAN++**は言語モデルを利用した高性能な形態素解析器です．言語モデルとして *Recurrent Neural Network Language Model(RNNLM)* を用いることにより，単語の並びの意味的な自然さを考慮した解析を行います．それにより JUMAN，MeCab に比べ大きく性能が向上しています．文法・辞書・出力フォーマット等は JUMAN から引き継いだものを利用しています．本システムは CREST「知識に基づく構造的言語処理の確立と知識インフラの構築」により開発されました．

## 2. インストール
### 動作環境
- OS: Linux (CentOS 6.7 で動作を確認) 
- 必要メモリ: 4GB 以上  
- ディスク容量: 2GB 以上  
### 必須ツール・ライブラリ
- gcc (4.9 以降)
- Boost C++ Libraries (1.57 以降)  
[\[link\]](http://www.boost.org/users/history/version_1_57_0.html)
### 推奨ライブラリ 
導入することで，動作を高速化することができます．インストール方法は，A. 推奨ライブラリのインストールを参照してください  
- gperftool  
[\[github\]](https://github.com/gperftools/gperftools)  
- libunwind (gperftool を64bit 環境で動作させるために必要)  
[\[download\]](http://download.savannah.gnu.org/releases/libunwind/libunwind-0.99-beta.tar.gz)

### インストール手順
JUMAN++ を使用するには,以下の手順で配布アーカイブをダウンロード,インストールす
る必要があります.インストールされるものは,JUMAN++本体,JUMAN++ のシステム標準辞書,シ
ステム標準モデル(訓練済みのパラメタ),言語モデルです.

% wget http://lotus.kuee.kyoto-u.ac.jp/nl-resource/jumanpp/jumanpp-1.00.tar.xz
% tar xJf jumanpp-1.00.tar.xz
% cd jumanpp-1.00
% ./configure 
% make
% sudo make install
```

インストール先を変える場合は, `./configure --prefix=/path/to/somewhere/` としてください．
現在は，Windows へのインストールはサポートしていません（将来的にcygwin 環境での動作をサポートする予定です）．
 
## 3. Quick Start
JUMAN++ を起動し，標準入力に UTF-8 でエンコードされた生文を入力することで解析を行います．ただし，`#`で始まる行はコメント行として扱い，解析は行いません．出力の形式は JUMAN と同様ですが，JUMANでうまく解析できなかった文も解析できるようになっています．

JUMANによる解析例
```
% echo "私もあさって日曜最終日" | juman
私もあさって日曜最終日
私 わたし 私 名詞 6 普通名詞 1 * 0 * 0 "代表表記:私/わたし 漢字読み:訓 カテゴリ:人"
も も も 助詞 9 副助詞 2 * 0 * 0 NIL
あさって あさって あさる 動詞 2 * 0 子音動詞ラ行 10 タ系連用テ形 14 "代表表記:漁る/あさる"
日曜 にちよう 日曜 名詞 6 時相名詞 10 * 0 * 0 "代表表記:日曜/にちよう カテゴリ:時間"
最 さい 最 接頭辞 13 名詞接頭辞 1 * 0 * 0 "代表表記:最/さい 内容語"
終日 しゅうじつ 終日 名詞 6 時相名詞 10 * 0 * 0 "代表表記:終日/しゅうじつ カテゴリ:時間"
EOS
```

JUMAN++による解析例
```
% echo "私もあさって日曜最終日" | jumanpp
私 わたし 私 名詞 6 普通名詞 1 * 0 * 0 "代表表記:私/わたし 漢字読み:訓 カテゴリ:人"
も も も 助詞 9 副助詞 2 * 0 * 0 NIL
あさって あさって あさって 名詞 6 時相名詞 10 * 0 * 0 "代表表記:明後日/あさって カテゴリ:時間"
日曜 にちよう 日曜 名詞 6 時相名詞 10 * 0 * 0 "代表表記:日曜/にちよう カテゴリ:時間"
最終 さいしゅう 最終だ 形容詞 3 * 0 ナノ形容詞 22 語幹 1 "代表表記:最終だ/さいしゅうだ 反義:形容詞:最初だ/さいしょだ"
日 ひ 日 名詞 6 時相名詞 10 * 0 * 0 "代表表記:日/ひ 漢字読み:訓 弱時相名詞 カテゴリ:時間"
@ 日 にち 日 名詞 6 時相名詞 10 * 0 * 0 "代表表記:日/にち 漢字読み:音 カテゴリ:時間"
EOS
```

インストールせずに試せるように，Web上で本システムを動かせるデモを用意しています．  
[デモ](http://lotus.kuee.kyoto-u.ac.jp/demo/jumanpp.cgi)

## 4. オプション解説
JUMAN++ の主なオプションは以下のとおりです．詳細はマニュアルを参照してください．
```
オプション:
  -s, --specifics N            N-Best 解をラティス形式で出力
  -B, --beam width             解析に利用する Beam 幅 (default: width = 5)
  -v, --version                バージョンを表示
      --debug                  デバッグ出力を表示します
  -h, --help                   ヘルプを表示
```

## 5. 出力形式
### JUMAN 形式 (default)
各行が１つの形態素を表します．形態素の各項目は半角スペース区切りで表され，各項目が表す内容は以下の通りです．
```
表層形 読み 見出し語 品詞大分類 品詞大分類ID 品詞細分類 品詞細分類ID 活用型 活用型ID 活用形 活用形ID 意味情報
```

出力例: 
```
% echo "ここにはいる" | jumanpp
ここ ここ ここ 指示詞 7 名詞形態指示詞 1 * 0 * 0 NIL
に に に 助詞 9 格助詞 1 * 0 * 0 NIL
は は は 助詞 9 副助詞 2 * 0 * 0 NIL
いる いる いる 動詞 2 * 0 子音動詞ラ行 10 基本形 2 "代表表記:要る/いる"
@ いる いる いる 動詞 2 * 0 母音動詞 1 基本形 2 "代表表記:鋳る/いる"
@ いる いる いる 動詞 2 * 0 母音動詞 1 基本形 2 "代表表記:居る/いる"
@ いる いる いる 動詞 2 * 0 母音動詞 1 基本形 2 "代表表記:射る/いる"
@ いる いる いる 動詞 2 * 0 子音動詞ラ行 10 基本形 2 "代表表記:煎る/いる ドメイン:料理・食事"
EOS
```

同じスパンにスコア・品詞が同一の形態素候補が複数ある場合は，他の候補を先頭に`@`をつけて表示します．また，`EOS` は文区切りを表します．

### 詳細出力形式 (-s)
詳細出力形式は，N-best 解の出力に対応し，各形態素が他のどの形態素と接続するかと
いう情報が付随する出力形式です．JUMAN 形式と同様に各行が1つの形態素を表し，形態
素の各項目はタブで区切られています．この形式では入力にタブが存在した場合，“\t
”に置き換えて表示します．1行目にはコメント行として N-best 解の各スコアを表示し
ます．各項目が表す内容は以下の通りです．

```
行頭記号	形態素ID	前方向に接続する形態素IDの列	開始文字位置	終了文字位置	表層形	代表表記	読み	見出し語	品詞大分類	品詞大分類ID	品詞細分類	品詞細分類ID	活用型	活用型ID	活用形	活用形ID	意味情報
```
行頭記号には以下の３種類があります．
* \# コメント行  
* \- 形態素行  
* EOS 文区切り  

出力例
```
% echo "ここにはいる" | jumanpp -L 5
-	21	0	0	1	ここ	ここ/ここ	ここ	ここ	指示詞	7	名詞形態	指示詞	1	*	0	*	0	特徴量スコア:-1.94682|言語モデルスコア:-0.710878|形態素解析スコア:-2.6577|ランク:1;2;3;4;5
-	44	21	2	2	に	に/に	に	に	助詞	9	接続助詞	3	*	0	*	0	特徴量スコア:-0.306839|言語モデルスコア:-0.302036|形態素解析スコア:-0.608875|ランク:5
-	43	21	2	2	に	に/に	に	に	助詞	9	格助詞	1	*	0	*	0	特徴量スコア:0.572581|言語モデルスコア:-0.302036|形態素解析スコア:0.270545|ランク:1;2;3;4
-	93	44;43	3	5	はいる	入る/はいる	はいる	はいる	動詞	2	*	0	子音動詞ラ行	10	基本形	2	自他動詞:他:入れる/いれる|反義:動詞:出る/でる|特徴量スコア:-0.693798|言語モデルスコア:-1.44292|形態素解析スコア:-2.13671|ランク:3
-	57	44;43	3	3	は	は/は	は	は	助詞	9	副助詞	2	*	0	*	0	特徴量スコア:0.498884|言語モデルスコア:-0.264319|形態素解析スコア:0.234565|ランク:1;2;4;5
-	137	57	4	5	いる	いる/いる	いる	いる	接尾辞	14	動詞性接尾辞	7	母音動詞	1	基本形	2	特徴量スコア:-1.50223|言語モデルスコア:-1.30923|形態素解析スコア:-2.81146|ランク:4
-	136	57	4	5	いる	鋳る/いる	いる	いる	動詞	2	*	0	母音動詞	1	基本形	2	特徴量スコア:-1.05733|言語モデルスコア:-0.652887|形態素解析スコア:-1.71022|ランク:1;2;5
-	135	57	4	5	いる	居る/いる	いる	いる	動詞	2	*	0	母音動詞	1	基本形	2	特徴量スコア:-1.05733|言語モデルスコア:-0.652887|形態素解析スコア:-1.71022|ランク:1;2;5
-	134	57	4	5	いる	射る/いる	いる	いる	動詞	2	*	0	母音動詞	1	基本形	2	特徴量スコア:-1.05733|言語モデルスコア:-0.652887|形態素解析スコア:-1.71022|ランク:1;2;5
-	133	57	4	5	いる	要る/いる	いる	いる	動詞	2	*	0	子音動詞ラ行	10	基本形	2	特徴量スコア:-1.05733|言語モデルスコア:-0.652887|形態素解析スコア:-1.71022|ランク:1;2;5
-	132	57	4	5	いる	煎る/いる	いる	いる	動詞	2	*	0	子音動詞ラ行	10	基本形	2	ドメイン:料理・食事|特徴量スコア:-1.05733|言語モデルスコア:-0.652887|形態素解析スコア:-1.71022|ランク:1;2;5
EOS
``` 

意味情報の区切りは JUMAN 型式と異なり，`|` を区切りとしています．
代表表記は JUMAN 形式 では意味情報の1つとして表示していましたが，詳細出力形式では意味情報とは独立に表示します．
また，詳細出力形式の場合のみ意味情報に**ランク**が出力されており，その形態素が N-best 解のうち 何番目の解に出現したかを表す．
同じスパンに同一スコアの形態素候補が複数ある場合は，同ランクの形態素を複数個表示します．
意味情報中の**特徴量スコア**，**言語モデルスコア**，**形態素解析スコア**は，解析時にその形態素に付与されたスコアを表します．
特徴量スコアは基本モデルの出力するスコア，言語モデルスコアは RNN 言語モデルの出力するスコア，形態素解析スコアはその合計値を表します．
詳細はマニュアルを参照してください．

## 6. 解析結果の仕様のうちJUMANと異なる点
動詞の連用形は名詞として用いられることがあります．例えば，"音の響きを大切にする"という文の"響き"という語は，動詞の"響く"の連用形が名詞化した形で用いられています．JUMANではこの動詞や形容詞の名詞化を扱わず，元の品詞の連用形として出力しており，名詞化に関する処理は後段の構文解析時におこなっていました．本システムでは，動詞の連用形が名詞化して用いられている場合には名詞として出力を行います．このため，JUMANの出力と本システムの出力を同時に扱う場合には注意が必要です．その他の相違点についてはマニュアルを参照して下さい．

出力例: JUMAN
```
% echo "音の響きを大切にする" | juman
音 おと 音 名詞 6 普通名詞 1 * 0 * 0 "代表表記:音/おと 漢字読み:訓 カテゴリ:抽象物"
@ 音 おん 音 名詞 6 普通名詞 1 * 0 * 0 "代表表記:音/おん 漢字読み:音 カテゴリ:抽象物"
の の の 助詞 9 格助詞 1 * 0 * 0 NIL
響き ひびき 響く 動詞 2 * 0 子音動詞カ行 2 基本連用形 8 "代表表記:響く/ひびく"
を を を 助詞 9 格助詞 1 * 0 * 0 NIL
大切に たいせつに 大切だ 形容詞 3 * 0 ナ形容詞 21 ダ列基本連用形 7 "代表表記:大切だ/たいせつだ 反義:形容詞:粗末だ/そまつだ"
する する する 接尾辞 14 動詞性接尾辞 7 サ変動詞 16 基本形 2 "代表表記:する/する"
EOS
```
出力例: JUMAN++
"響き" を名詞として出力し，意味情報に形態素解析時に名詞化を行ったことを表す `連用形名詞化:形態素解析` という情報を追加します．
```
% echo "音の響きを大切にする" | jumanpp
音 おん 音 名詞 6 普通名詞 1 * 0 * 0 "代表表記:音/おん 漢字読み:音 カテゴリ:抽象物"
@ 音 おと 音 名詞 6 普通名詞 1 * 0 * 0 "代表表記:音/おと 漢字読み:訓 カテゴリ:抽象物"
の の の 助詞 9 格助詞 1 * 0 * 0 NIL
響き ひびき 響き 名詞 6 普通名詞 1 * 0 * 0 "代表表記:響き/ひびき 連用形名詞化:形態素解析"
を を を 助詞 9 格助詞 1 * 0 * 0 NIL
大切に たいせつに 大切だ 形容詞 3 * 0 ナ形容詞 21 ダ列基本連用形 7 "代表表記:大切だ/たいせつだ 反義:形容 詞:粗末だ/そまつだ"
する する する 接尾辞 14 動詞性接尾辞 7 サ変動詞 16 基本形 2 "代表表記:する/する"
EOS
```

## 7. 動作速度
本システムは言語モデル等の計算コストが高く，解析速度は 約20文/s 程度とJUMAN等に比較すると解析に時間を必要としますが，後段の処理として想定している構文・格解析 (KNP) と比べた解析時間は 1/5 程度となっており，パイプライン処理を行う上で十分な解析速度を達成しています．

## 8. 今後の開発予定
- 動作の高速化
- 辞書・モデルの改良 (随時公開予定)
- Windows 対応
- 中国語対応

## 謝辞
言語モデルの学習には, [faster-rnnlm](https://github.com/yandex/faster-rnnlm) を利用しています．言語モデルの利用には，[RNNLM-toolkit](http://rnnlm.org/)のコードを一部利用しています．Double-Array を扱うため Taku Kudo 氏の [Darts](http://chasen.org/~taku/software/darts/)を利用しています．CDBの読み込みに [tinycdb](http://www.corpit.ru/mjt/tinycdb.html) のコードを利用しています．コマンドラインの解析に Hideyuki Tanaka 氏の [cmdline](https://github.com/tanakh/cmdline) を利用しています． 各ソフトウェア，ライブラリの製作者様に心から感謝申し上げます．

## 参考文献
"Morphological Analysis for Unsegmented Languages using Recurrent Neural Network Language Model. Hajime Morita, Daisuke Kawahara, Sadao Kurohashi. Proceedings of EMNLP 2015: Conference on Empirical Methods in Natural Language Processing,  pp.2292-2297" 
[pdf](http://lotus.kuee.kyoto-u.ac.jp/~morita/paper/morita_EMNLP2015_cameraready.pdf)
[poster](http://lotus.kuee.kyoto-u.ac.jp/~morita/paper/morita_EMNLP2015_poster.pptx)

"RNN 言語モデルを用いた日本語形態素解析の実用化. 森田一, 黒橋 禎夫. 情報処理学会 第78回全国大会"
[pdf](http://lotus.kuee.kyoto-u.ac.jp/~morita/paper/IPSJ2016_morita.pdf)

JUMAN ユーザーマニュアル
[link](http://nlp.ist.i.kyoto-u.ac.jp/?JUMAN)

## A. 推奨ライブラリのインストール方法
### libunwind
```
% wget http://download.savannah.gnu.org/releases/libunwind/libunwind-0.99-beta.tar.gz
% tar xzf libunwind-0.99-beta.tar.gz
% cd libunwind-0.99-beta
% ./configure --prefix=/path/to/somewhere/
% make 
% make install
```

### gperftools
```
% ./configure --prefx=/path/to/somewhere/
% make
% # 64bit 環境で，ld が32bit 用のライブラリをリンクしようとする場合には，
% # make のオプションに　UNWIND_LIBS=-lunwind-x86_64 と指定して下さい．
% make install
```

